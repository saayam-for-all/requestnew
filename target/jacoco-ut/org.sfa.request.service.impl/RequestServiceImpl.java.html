<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RequestServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">request</a> &gt; <a href="index.source.html" class="el_package">org.sfa.request.service.impl</a> &gt; <span class="el_source">RequestServiceImpl.java</span></div><h1>RequestServiceImpl.java</h1><pre class="source lang-java linenums">package org.sfa.request.service.impl;

import org.sfa.request.constant.SaayamStatusCode;
import org.sfa.request.response.PagedResponse;
import org.sfa.request.dto.RequestDTO;
import org.sfa.request.exception.types.ConflictException;
import org.sfa.request.exception.types.EnumUnspecifiedException;
import org.sfa.request.exception.types.InvalidRequestException;
import org.sfa.request.exception.types.NotFoundException;
import org.sfa.request.model.entity.*;
import org.sfa.request.model.enums.RequestStatusEnum;
import org.sfa.request.repository.*;
import org.sfa.request.response.SaayamResponse;
import lombok.RequiredArgsConstructor;
import org.sfa.request.service.api.RequestService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.context.MessageSource;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.ZonedDateTime;
import java.util.Locale;
import java.util.Optional;

/**
 * ClassName: RequestServiceImpl
 * Package: org.sfa.request.service.impl
 * Description:
 *
 * This class implements the RequestService interface, providing business logic
 * for handling various operations related to requests in the Saayam For All system.
 * It manages the creation, retrieval, updating, deletion, cancellation, and resumption
 * of requests. The class utilizes various repositories to interact with the database
 * and applies transactional management to ensure data consistency. It also handles
 * validation of request details, such as priority, type, category, and status.
 *
 * Key functionalities include:
 * - Creating new requests and saving them to the database.
 * - Retrieving existing requests by ID, including both active and deleted ones.
 * - Updating existing requests with new details, while handling specific constraints like
 *   preventing updates to canceled requests.
 * - Deleting requests by marking them as deleted rather than physically removing them
 *   from the database.
 * - Canceling requests, changing their status to 'Cancelled'.
 * - Resuming requests that were previously canceled, reverting their status to 'Created'.
 *
 * This class ensures proper exception handling by throwing specific exceptions
 * like NotFoundException, InvalidRequestException, ConflictException, and EnumUnspecifiedException
 * based on various validation and business logic scenarios. It also utilizes a MessageSource
 * for internationalization, providing localized success and error messages.
 *
 * @author Fan Peng
 * Create 2024/6/14 23:38
 * @version 1.0
 */
@Service
<span class="fc" id="L62">@RequiredArgsConstructor</span>
public class RequestServiceImpl implements RequestService {

<span class="fc" id="L65">    private static final Logger logger = LoggerFactory.getLogger(RequestServiceImpl.class);</span>

    private final RequestRepository requestRepository;
    private final RequestStatusRepository requestStatusRepository;
    private final RequestPriorityRepository requestPriorityRepository;
    private final RequestTypeRepository requestTypeRepository;
    private final RequestCategoryRepository requestCategoryRepository;
    private final RequestForRepository requestForRepository;
    private final MessageSource messageSource;

    @Override
    @Transactional
    public SaayamResponse&lt;Request&gt; createRequest(String requesterId, RequestDTO requestDTO, Locale locale) {
<span class="nc" id="L78">        validateEnumIds(requestDTO, locale);</span>

<span class="nc" id="L80">        RequestPriority requestPriority = getRequestPriority(requestDTO.getRequestPriority().getRequestPriorityId(), locale);</span>
<span class="nc" id="L81">        RequestType requestType = getRequestType(requestDTO.getRequestType().getRequestTypeId(), locale);</span>
<span class="nc" id="L82">        RequestCategory requestCategory = getRequestCategory(requestDTO.getRequestCategory().getRequestCategoryId(), locale);</span>
<span class="nc" id="L83">        RequestFor requestFor = getRequestFor(requestDTO.getRequestFor().getRequestForId(), locale);</span>
<span class="nc" id="L84">        RequestStatus requestStatus = getRequestStatus(RequestStatusEnum.CREATED.getId(), locale);</span>

<span class="nc" id="L86">        Request request = buildRequest(</span>
                requesterId,
                requestDTO,
                requestPriority,
                requestType,
                requestCategory,
                requestFor,
                requestStatus
        );
<span class="nc" id="L95">        Request savedRequest = requestRepository.save(request);</span>

<span class="nc" id="L97">        logger.info(&quot;Created request with ID: {}&quot;, savedRequest.getRequestId());</span>
<span class="nc" id="L98">        String message = messageSource.getMessage(&quot;success.requestCreated&quot;, new Object[]{savedRequest.getRequestId()}, locale);</span>
<span class="nc" id="L99">        return SaayamResponse.success(SaayamStatusCode.REQUEST_CREATED, message, savedRequest);</span>
    }

    @Override
    @Transactional(readOnly = true)
    public SaayamResponse&lt;Request&gt; getRequestById(String requesterId, String requestId, Locale locale) {
<span class="nc" id="L105">        Request request = findActiveRequest(requesterId, requestId, locale);</span>
<span class="nc" id="L106">        logger.info(&quot;Retrieved request with ID: {}&quot;, requestId);</span>
<span class="nc" id="L107">        String message = messageSource.getMessage(&quot;success.requestFound&quot;, new Object[]{requestId}, locale);</span>
<span class="nc" id="L108">        return SaayamResponse.success(SaayamStatusCode.SUCCESS, message, request);</span>
    }

    @Override
    @Transactional(readOnly = true)
    public SaayamResponse&lt;PagedResponse&lt;Request&gt;&gt; getRequests(String requesterId, Pageable pageable, Locale locale) {
<span class="nc bnc" id="L114" title="All 2 branches missed.">        Sort sort = pageable.getSort().isSorted() ? pageable.getSort() : Sort.by(Sort.Direction.DESC, &quot;requestId&quot;);</span>
<span class="nc" id="L115">        Pageable sortedPageable = PageRequest.of(pageable.getPageNumber(), pageable.getPageSize(), sort);</span>
<span class="nc" id="L116">        Page&lt;Request&gt; requests = requestRepository.findAllActiveByRequesterId(requesterId, RequestStatusEnum.DELETED.getId(), sortedPageable);</span>

<span class="nc" id="L118">        PagedResponse&lt;Request&gt; pagedResponse = new PagedResponse&lt;&gt;(requests);</span>

<span class="nc" id="L120">        logger.info(&quot;Retrieved {} requests for requester ID: {}&quot;, requests.getContent().size(), requesterId);</span>
<span class="nc" id="L121">        String message = messageSource.getMessage(&quot;success.requestsRetrieved&quot;, null, locale);</span>
<span class="nc" id="L122">        return SaayamResponse.success(SaayamStatusCode.SUCCESS, message, pagedResponse);</span>
    }

    @Override
    @Transactional
    public SaayamResponse&lt;Request&gt; updateRequest(String requesterId, String requestId, RequestDTO requestDTO, Locale locale) {
<span class="nc" id="L128">        Request request = findActiveRequest(requesterId, requestId, locale);</span>

<span class="nc bnc" id="L130" title="All 2 branches missed.">        if (request.getRequestStatus().getRequestStatusId() == RequestStatusEnum.CANCELLED.getId()) {</span>
<span class="nc" id="L131">            throw new InvalidRequestException(</span>
<span class="nc" id="L132">                    messageSource.getMessage(&quot;error.updateCancelledRequest&quot;, new Object[]{requestId}, locale)</span>
            );
        }

<span class="nc" id="L136">        updateRequestFields(request, requestDTO, locale);</span>
<span class="nc" id="L137">        request.setLastUpdatedAt(ZonedDateTime.now());</span>
<span class="nc" id="L138">        Request updatedRequest = requestRepository.save(request);</span>

<span class="nc" id="L140">        logger.info(&quot;Updated request with ID: {}&quot;, requestId);</span>
<span class="nc" id="L141">        String message = messageSource.getMessage(&quot;success.requestUpdated&quot;, new Object[]{requestId}, locale);</span>
<span class="nc" id="L142">        return SaayamResponse.success(SaayamStatusCode.REQUEST_UPDATED, message, updatedRequest);</span>
    }

    @Override
    @Transactional
    public SaayamResponse&lt;Void&gt; deleteRequest(String requesterId, String requestId, Locale locale) {
<span class="nc" id="L148">        Request request = findRequestIncludingDeleted(requesterId, requestId, locale);</span>

<span class="nc bnc" id="L150" title="All 2 branches missed.">        if (request.getRequestStatus().getRequestStatusId() != RequestStatusEnum.DELETED.getId()) {</span>
<span class="nc" id="L151">            RequestStatus deletedStatus = getRequestStatus(RequestStatusEnum.DELETED.getId(), locale);</span>
<span class="nc" id="L152">            request.setRequestStatus(deletedStatus);</span>
<span class="nc" id="L153">            request.setLastUpdatedAt(ZonedDateTime.now());</span>
<span class="nc" id="L154">            requestRepository.save(request);</span>

<span class="nc" id="L156">            logger.info(&quot;Deleted request with ID: {}&quot;, requestId);</span>
<span class="nc" id="L157">            String message = messageSource.getMessage(&quot;success.requestDeleted&quot;, new Object[]{requestId}, locale);</span>
<span class="nc" id="L158">            return SaayamResponse.success(SaayamStatusCode.REQUEST_DELETED, message, null);</span>
        } else {
<span class="nc" id="L160">            throw new ConflictException(</span>
<span class="nc" id="L161">                    messageSource.getMessage(&quot;error.requestAlreadyDeleted&quot;, new Object[]{requestId}, locale));</span>
        }
    }

    @Override
    @Transactional
    public SaayamResponse&lt;Request&gt; cancelRequest(String requesterId, String requestId, Locale locale) {
<span class="nc" id="L168">        Request request = findActiveRequest(requesterId, requestId, locale);</span>

<span class="nc bnc" id="L170" title="All 2 branches missed.">        if (request.getRequestStatus().getRequestStatusId() == RequestStatusEnum.CANCELLED.getId()) {</span>
<span class="nc" id="L171">            throw new InvalidRequestException(</span>
<span class="nc" id="L172">                    messageSource.getMessage(&quot;error.requestAlreadyCancelled&quot;, new Object[]{requestId}, locale)</span>
            );
        }

<span class="nc" id="L176">        RequestStatus cancelledStatus = getRequestStatus(RequestStatusEnum.CANCELLED.getId(), locale);</span>
<span class="nc" id="L177">        request.setRequestStatus(cancelledStatus);</span>
<span class="nc" id="L178">        request.setLastUpdatedAt(ZonedDateTime.now());</span>
<span class="nc" id="L179">        Request cancelledRequest = requestRepository.save(request);</span>

<span class="nc" id="L181">        logger.info(&quot;Cancelled request with ID: {}&quot;, requestId);</span>
<span class="nc" id="L182">        String message = messageSource.getMessage(&quot;success.requestCancelled&quot;, new Object[]{requestId}, locale);</span>
<span class="nc" id="L183">        return SaayamResponse.success(SaayamStatusCode.REQUEST_CANCELLED, message, cancelledRequest);</span>
    }

    @Override
    @Transactional
    public SaayamResponse&lt;Request&gt; resumeRequest(String requesterId, String requestId, Locale locale) {
<span class="nc" id="L189">        Request request = findActiveRequest(requesterId, requestId, locale);</span>

<span class="nc bnc" id="L191" title="All 2 branches missed.">        if (request.getRequestStatus().getRequestStatusId() != RequestStatusEnum.CANCELLED.getId()) {</span>
<span class="nc" id="L192">            throw new InvalidRequestException(</span>
<span class="nc" id="L193">                    messageSource.getMessage(&quot;error.requestNotCancelled&quot;, new Object[]{requestId}, locale)</span>
            );
        }

<span class="nc" id="L197">        RequestStatus createdStatus = getRequestStatus(RequestStatusEnum.CREATED.getId(), locale);</span>
<span class="nc" id="L198">        request.setRequestStatus(createdStatus);</span>
<span class="nc" id="L199">        request.setLastUpdatedAt(ZonedDateTime.now());</span>
<span class="nc" id="L200">        Request resumedRequest = requestRepository.save(request);</span>

<span class="nc" id="L202">        logger.info(&quot;Resumed request with ID: {}&quot;, requestId);</span>
<span class="nc" id="L203">        String message = messageSource.getMessage(&quot;success.requestResumed&quot;, new Object[]{requestId}, locale);</span>
<span class="nc" id="L204">        return SaayamResponse.success(SaayamStatusCode.REQUEST_RESUMED, message, resumedRequest);</span>
    }

    private void validateEnumIds(RequestDTO requestDTO, Locale locale) {
<span class="nc" id="L208">        validateEnumId(requestDTO.getRequestPriority().getRequestPriorityId(), &quot;RequestPriority&quot;, locale);</span>
<span class="nc" id="L209">        validateEnumId(requestDTO.getRequestType().getRequestTypeId(), &quot;RequestType&quot;, locale);</span>
<span class="nc" id="L210">        validateEnumId(requestDTO.getRequestCategory().getRequestCategoryId(), &quot;RequestCategory&quot;, locale);</span>
<span class="nc" id="L211">        validateEnumId(requestDTO.getRequestFor().getRequestForId(), &quot;RequestFor&quot;, locale);</span>
<span class="nc" id="L212">    }</span>


    private void validateEnumId(Integer id, String enumType, Locale locale) {
<span class="nc bnc" id="L216" title="All 4 branches missed.">        if (id == null || id == 0) {</span>
<span class="nc" id="L217">            throw new EnumUnspecifiedException(</span>
<span class="nc" id="L218">                    messageSource.getMessage(&quot;error.enumUnspecified&quot;, new Object[]{enumType}, locale)</span>
            );
        }
<span class="nc" id="L221">    }</span>

    private RequestPriority getRequestPriority(Integer id, Locale locale) {
<span class="nc" id="L224">        return requestPriorityRepository.findById(id)</span>
<span class="nc" id="L225">                .orElseThrow(() -&gt; new NotFoundException(</span>
<span class="nc" id="L226">                        messageSource.getMessage(&quot;error.invalidRequestPriority&quot;, new Object[]{id}, locale)</span>
                ));
    }

    private RequestType getRequestType(Integer id, Locale locale) {
<span class="nc" id="L231">        return requestTypeRepository.findById(id)</span>
<span class="nc" id="L232">                .orElseThrow(() -&gt; new NotFoundException(</span>
<span class="nc" id="L233">                        messageSource.getMessage(&quot;error.invalidRequestType&quot;, new Object[]{id}, locale)</span>
                ));
    }

    private RequestCategory getRequestCategory(Integer id, Locale locale) {
<span class="nc" id="L238">        return requestCategoryRepository.findById(id)</span>
<span class="nc" id="L239">                .orElseThrow(() -&gt; new NotFoundException(</span>
<span class="nc" id="L240">                        messageSource.getMessage(&quot;error.invalidRequestCategory&quot;, new Object[]{id}, locale)</span>
                ));
    }

    private RequestFor getRequestFor(Integer id, Locale locale) {
<span class="nc" id="L245">        return requestForRepository.findById(id)</span>
<span class="nc" id="L246">                .orElseThrow(() -&gt; new NotFoundException(</span>
<span class="nc" id="L247">                        messageSource.getMessage(&quot;error.invalidRequestFor&quot;, new Object[]{id}, locale)</span>
                ));
    }

    private RequestStatus getRequestStatus(Integer id, Locale locale) {
<span class="nc" id="L252">        return requestStatusRepository.findById(id)</span>
<span class="nc" id="L253">                .orElseThrow(() -&gt; new NotFoundException(</span>
<span class="nc" id="L254">                        messageSource.getMessage(&quot;error.invalidRequestStatus&quot;, new Object[]{id}, locale)</span>
                ));
    }

    private Request findActiveRequest(String requesterId, String requestId, Locale locale) {
<span class="nc" id="L259">        return requestRepository.findActiveByRequestIdAndRequesterId(requestId, requesterId, RequestStatusEnum.DELETED.getId())</span>
<span class="nc" id="L260">                .orElseThrow(() -&gt; new NotFoundException(</span>
<span class="nc" id="L261">                        messageSource.getMessage(&quot;error.requestNotFound&quot;, new Object[]{requestId, requesterId}, locale)</span>
                ));
    }

    private Request findRequestIncludingDeleted(String requesterId, String requestId, Locale locale) {
<span class="nc" id="L266">        return requestRepository.findByRequestIdAndRequesterIdIncludingDeleted(requestId, requesterId)</span>
<span class="nc" id="L267">                .orElseThrow(() -&gt; new NotFoundException(</span>
<span class="nc" id="L268">                        messageSource.getMessage(&quot;error.requestNotFound&quot;, new Object[]{requestId, requesterId}, locale)</span>
                ));
    }

    private Request buildRequest(
            String requesterId,
            RequestDTO requestDTO,
            RequestPriority requestPriority,
            RequestType requestType,
            RequestCategory requestCategory,
            RequestFor requestFor,
            RequestStatus requestStatus
    ) {
<span class="nc" id="L281">        ZonedDateTime now = ZonedDateTime.now();</span>
<span class="nc" id="L282">        return Request.builder()</span>
<span class="nc" id="L283">                .requesterId(requesterId)</span>
<span class="nc" id="L284">                .requestStatus(requestStatus)</span>
<span class="nc" id="L285">                .requestPriority(requestPriority)</span>
<span class="nc" id="L286">                .requestType(requestType)</span>
<span class="nc" id="L287">                .requestCategory(requestCategory)</span>
<span class="nc" id="L288">                .requestFor(requestFor)</span>
<span class="nc" id="L289">                .city(requestDTO.getCity())</span>
<span class="nc" id="L290">                .zipCode(requestDTO.getZipCode())</span>
<span class="nc" id="L291">                .requestDescription(requestDTO.getRequestDescription())</span>
<span class="nc" id="L292">                .audioRequestDescription(requestDTO.getAudioRequestDescription())</span>
<span class="nc" id="L293">                .submittedAt(now)</span>
<span class="nc" id="L294">                .leadVolunteerUserId(requestDTO.getLeadVolunteerUserId())</span>
<span class="nc" id="L295">                .servicedAt(requestDTO.getServicedAt())</span>
<span class="nc" id="L296">                .lastUpdatedAt(now)</span>
<span class="nc" id="L297">                .build();</span>
    }

    private void updateRequestFields(
            Request request,
            RequestDTO requestDTO,
            Locale locale
    ) {
<span class="nc" id="L305">        Optional.ofNullable(requestDTO.getRequestPriority())</span>
<span class="nc" id="L306">                .ifPresent(priority -&gt; request.setRequestPriority(getRequestPriority(priority.getRequestPriorityId(), locale)));</span>

<span class="nc" id="L308">        Optional.ofNullable(requestDTO.getRequestType())</span>
<span class="nc" id="L309">                .ifPresent(type -&gt; request.setRequestType(getRequestType(type.getRequestTypeId(), locale)));</span>

<span class="nc" id="L311">        Optional.ofNullable(requestDTO.getRequestCategory())</span>
<span class="nc" id="L312">                .ifPresent(category -&gt; request.setRequestCategory(getRequestCategory(category.getRequestCategoryId(), locale)));</span>

<span class="nc" id="L314">        Optional.ofNullable(requestDTO.getRequestFor())</span>
<span class="nc" id="L315">                .ifPresent(requestFor -&gt; request.setRequestFor(getRequestFor(requestFor.getRequestForId(), locale)));</span>

<span class="nc" id="L317">        Optional.ofNullable(requestDTO.getCity()).ifPresent(request::setCity);</span>

<span class="nc" id="L319">        Optional.ofNullable(requestDTO.getZipCode()).ifPresent(request::setZipCode);</span>

<span class="nc" id="L321">        Optional.ofNullable(requestDTO.getRequestDescription()).ifPresent(request::setRequestDescription);</span>

<span class="nc" id="L323">        Optional.ofNullable(requestDTO.getAudioRequestDescription()).ifPresent(request::setAudioRequestDescription);</span>

<span class="nc" id="L325">        Optional.ofNullable(requestDTO.getLeadVolunteerUserId()).ifPresent(request::setLeadVolunteerUserId);</span>

<span class="nc" id="L327">        Optional.ofNullable(requestDTO.getServicedAt()).ifPresent(request::setServicedAt);</span>
<span class="nc" id="L328">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>